name: Deploy Flask App to Civo Compute

on:
  push:
    branches:
      - main # Trigger this workflow whenever a push is made to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 1. Setup SSH Agent ---
      - name: Setup SSH private key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          # This secret holds the private key you generated (see step 3)
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
# --- 2. Remote Deployment Commands (FIXED) ---
      - name: Pull and Restart App on Civo Instance
        uses: appleboy/ssh-action@v1.0.3 # Use a reliable SSH action
        with:
          host: 212.2.248.120            # Your Civo Public IP
          username: ubuntu               # The user you connect as
          key: ${{ secrets.SSH_PRIVATE_KEY }} # Uses the secret key directly
          script: |
            echo "Deployment started on remote server..."
            
            APP_DIR="/home/ubuntu/flaskapp"
            cd $APP_DIR || exit 1 # Exit if directory change fails

            # Pull the latest code from GitHub
            git pull origin main

            # Re-install dependencies (always a good idea in CI/CD)
            source venv/bin/activate
            pip install -r requirements.txt

            # Restart the Gunicorn service to pick up the new code
            sudo systemctl restart flaskapp

            echo "Deployment finished. Flask app service restarted."